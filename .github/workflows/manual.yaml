name: pre_release

on: 
  workflow_dispatch:
    inputs:
      env:
        description: "deploy cluster(dev/stg/prd)"
        required:  false
      build_targets:
        description: "paths to build.yaml. multiple files are separated by ','"
        required:  false

jobs:
  pre-release:
    runs-on: ubuntu-latest
    steps:
    - run: |
        targets=${{ github.event.inputs.build_targets }}
        IFS=','
        for t in $targets
        do
          echo "build_target: $t"
        done
      name: debug

    - run: |
        echo "env: ${{ github.event.inputs }}"
        echo "build_targets: ${{ github.event.inputs }}"
        echo "all: ${{ github.event.inputs }}"
    - uses: actions/checkout@v2
    - uses: imranismail/setup-kustomize@v1
      with:
        kustomize-version: 3.8.1
    - name: build image
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        cd src/cache/deployments/overlays
        kustomize edit set image app_image=foo@${{ github.sha }}
    - name: create pull-request
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        WORKING_BRANCH: 'pre-release/${{ github.run_id }}'
      run: |
        git config --global user.name "Github Actions"
        git switch -c $WORKING_BRANCH origin/master
        git commit -am "buiding image"
        git push origin $WORKING_BRANCH
        hub pull-request -m "[pre-release] ${{ github.run_id }}"
